<!DOCTYPE html>
<html lang="ja">
<head>
  <link rel="apple-touch-icon" href="icon-191.png">
  <link rel="icon" href="icon-191.png">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>フリマ利益計算ツール（保存付き）</title>
  <style>
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
    }

    body {
      margin: 0;
      padding: 16px;
      background: #f4f4f5;
      display: flex;
      justify-content: center;
    }

    body {
      width: 100%;
      max-width: 100%;
      overflow-x: hidden;   /* 横スクロールを禁止 */
    }

    body {
      overscroll-behavior-x: none;  /* 横方向のゴムみたいな動き防止（対応ブラウザ） */
    }

    .card {
      background: #ffffff;
      width: 100%;
      max-width: 520px;
      padding: 20px 18px 24px;
      border-radius: 16px;
      box-shadow: 0 8px 20px rgba(15, 23, 42, 0.08);
    }

    h1 {
      font-size: 1.3rem;
      margin: 0 0 4px;
      text-align: center;
    }

    .subtitle {
      font-size: 0.8rem;
      color: #6b7280;
      text-align: center;
      margin-bottom: 16px;
    }

    .field {
      margin-bottom: 12px;
    }

    .field label {
      display: block;
      font-size: 0.85rem;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .field-row {
      display: flex;
      gap: 6px;
      align-items: center;
    }

    input[type="number"],
    input[type="text"],
    select {
      width: 100%;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid #d4d4d8;
      font-size: 0.9rem;
      background: #ffffff;
    }

    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    .suffix {
      font-size: 0.85rem;
      color: #6b7280;
      white-space: nowrap;
    }

    .btn-row {
      display: flex;
      gap: 8px;
      margin-top: 8px;
      flex-wrap: wrap;
    }

    button {
      width: 100%;
      padding: 10px;
      border-radius: 999px;
      border: none;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      background: #2563eb;
      color: white;
      box-shadow: 0 6px 14px rgba(37, 99, 235, 0.35);
      transition: transform 0.08s ease, box-shadow 0.08s ease, opacity 0.08s ease;
      white-space: nowrap;
    }

    button.secondary {
      background: #e5e7eb;
      color: #111827;
      box-shadow: 0 4px 10px rgba(148, 163, 184, 0.6);
    }

    button:active {
      transform: translateY(1px);
      box-shadow: 0 3px 7px rgba(37, 99, 235, 0.35);
      opacity: 0.9;
    }

    .results-wrapper {
      margin-top: 18px;
      border-top: 1px dashed #e5e7eb;
      padding-top: 12px;
    }

    .shipping-summary {
      font-size: 0.78rem;
      color: #6b7280;
      margin-bottom: 10px;
      line-height: 1.4;
    }

    .market-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .market-card {
      padding: 8px 10px;
      border-radius: 12px;
      background: #eff6ff;
      font-size: 0.85rem;
    }

    .market-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 4px;
      gap: 8px;
    }

    .market-name {
      font-weight: 700;
      font-size: 0.95rem;
      white-space: nowrap;
    }

    .profit-value {
      font-weight: 700;
      font-size: 1rem;
      color: #1d4ed8;
      text-align: right;
    }

    .profit-negative {
      color: #b91c1c;
    }

    .market-rows {
      margin-top: 4px;
    }

    .row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 2px;
      gap: 10px;
    }

    .label {
      color: #6b7280;
      white-space: nowrap;
    }

    .saved-block {
      margin-top: 18px;
      padding-top: 12px;
      border-top: 1px dashed #e5e7eb;
      font-size: 0.8rem;
    }

    .saved-block-title {
      font-weight: 600;
      margin-bottom: 6px;
    }

    .saved-row {
      display: flex;
      gap: 6px;
      align-items: center;
      flex-wrap: wrap;
    }

    .saved-row select {
      flex: 1;
      min-width: 200px;
    }

    .saved-row button {
      width: auto;
      padding-inline: 12px;
      font-size: 0.8rem;
      box-shadow: none;
    }

    .footer-note {
      margin-top: 10px;
      font-size: 0.75rem;
      color: #9ca3af;
      text-align: right;
    }

    @media (prefers-color-scheme: dark) {
      body {
        background: #020617;
      }
      .card {
        background: #020617;
        color: #e5e7eb;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.6);
      }
      input[type="number"],
      input[type="text"],
      select {
        background: #020617;
        color: #e5e7eb;
        border-color: #4b5563;
      }
      .subtitle,
      .label,
      .suffix,
      .shipping-summary,
      .footer-note {
        color: #9ca3af;
      }
      .results-wrapper,
      .saved-block {
        border-top-color: #374151;
      }
      .market-card {
        background: #1d4ed8;
      }
      .profit-value {
        color: #f9fafb;
      }
      button.secondary {
        background: #1f2937;
        color: #e5e7eb;
      }
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>フリマ利益計算</h1>
    <div class="subtitle">チン コーポレーション株式会社</div>

    <!-- ▼▼▼ 入力欄 ▼▼▼ -->
    <div class="field">
      <label for="itemName">商品名</label>
      <input type="text" id="itemName" placeholder="例: Tシャツ 白 Lサイズ" />
    </div>

    <div class="field">
      <label for="price">販売価格</label>
      <div class="field-row">
        <input type="number" id="price" inputmode="decimal" placeholder="例: 3000" />
        <span class="suffix">円</span>
      </div>
    </div>

    <!-- ★追加：目標利益 -->
    <div class="field">
      <label for="targetProfit">目標利益（逆算用）</label>
      <div class="field-row">
        <input type="number" id="targetProfit" inputmode="decimal" placeholder="例: 500" />
        <span class="suffix">円</span>
      </div>
    </div>

    <div class="field">
      <label for="cost">仕入れ値 / 原価</label>
      <div class="field-row">
        <input type="number" id="cost" inputmode="decimal" placeholder="例: 1500" />
        <span class="suffix">円</span>
      </div>
    </div>

    <div class="field">
      <label for="other">その他経費（梱包材など）</label>
      <div class="field-row">
        <input type="number" id="other" inputmode="decimal" placeholder="例: 100" />
        <span class="suffix">円</span>
      </div>
    </div>

    <div class="field">
      <label for="shippingMethod">発送方法</label>
      <select id="shippingMethod"></select>
    </div>

    <div class="btn-row">
      <button id="calcBtn">利益を計算</button>
      <!-- ★追加：販売価格を計算 -->
      <button id="priceCalcBtn" class="secondary">販売価格を計算</button>
      <button id="saveBtn" class="secondary">現在の内容を保存</button>
    </div>

    <!-- ▼▼▼ 結果表示 ▼▼▼ -->
    <div class="results-wrapper">
      <div class="shipping-summary" id="shippingSummary">
        発送方法とサイト別送料をここに表示します。
      </div>
      <div class="market-list" id="marketResults"></div>
    </div>

    <!-- ▼▼▼ 保存済みデータ ▼▼▼ -->
    <div class="saved-block">
      <div class="saved-block-title">保存した商品</div>
      <div class="saved-row">
        <select id="savedItemsSelect">
          <option value="">（未選択）</option>
        </select>
        <button id="loadBtn" class="secondary">読み込み</button>
        <button id="deleteBtn" class="secondary">削除</button>
      </div>
    </div>

    <div class="footer-note">
      ver. 0<br />
    </div>
  </div>

  <script>
    /**********************************************
     * ① サイト別の設定（手数料データベース）
     **********************************************/
    const MARKETPLACES = {
      mercari: { key: "mercari", label: "メルカリ", feeRate: 10.0 },
      yahoo:   { key: "yahoo",   label: "ヤフオク! ", feeRate: 5.0  },
      rakuma:  { key: "rakuma",  label: "ラクマ",     feeRate: 10.0 },
    };

    /**********************************************
     * ② 発送方法データベース
     **********************************************/
    const SHIPPING_METHODS = [
      { id: "yp_post_mini", label: "ゆうパケットポスト mini", cost: { mercari: 180, yahoo: 180, rakuma: 170 } },
      { id: "yp_post",      label: "ゆうパケットポスト",      cost: { mercari: 220, yahoo: 215, rakuma: 180 } },
      { id: "yp_post_plus", label: "ゆうパケット プラス",      cost: { mercari: 520, yahoo: 475, rakuma: 445 } },
      { id: "kn_npost",     label: "ネコポス",                  cost: { mercari: 210, yahoo: 210, rakuma: 200 } },
      { id: "kn_conpact",   label: "宅急便コンパクト",          cost: { mercari: 450, yahoo: 560, rakuma: 500 } },
      { id: "yp_yp",        label: "60ゆうパック",              cost: { mercari: 750, yahoo: 750, rakuma: 700 } },
      { id: "yp_yp8",       label: "80ゆうパック",              cost: { mercari: 850, yahoo: 850, rakuma: 800 } },
      { id: "yp_yp10",      label: "100ゆうパック",             cost: { mercari: 1050, yahoo: 1050, rakuma: 1150 } },
      { id: "yp_yp12",      label: "120ゆうパック",             cost: { mercari: 1200, yahoo: 1200, rakuma: 1350 } },
      { id: "kn_tk",        label: "60宅急便",                  cost: { mercari: 750, yahoo: 750, rakuma: 650 } },
      { id: "kn_tk8",       label: "80宅急便",                  cost: { mercari: 850, yahoo: 850, rakuma: 750 } },
      { id: "kn_tk10",      label: "100宅急便",                 cost: { mercari: 1050, yahoo: 1050, rakuma: 1050 } },
      { id: "kn_tk12",      label: "120宅急便",                 cost: { mercari: 1200, yahoo: 1200, rakuma: 1200 } },
      // ここに追加してOK
    ];

    /**********************************************
     * ③ localStorage 設定
     **********************************************/
    const STORAGE_KEY = "freemarketCalcSavedItems_v1";

    function loadSavedItems() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return [];
        const parsed = JSON.parse(raw);
        if (!Array.isArray(parsed)) return [];
        return parsed;
      } catch (e) {
        console.error("loadSavedItems error", e);
        return [];
      }
    }

    function saveItemsToStorage(items) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(items));
    }

    /**********************************************
     * ④ 共通関数
     **********************************************/
    function toNumber(value) {
      const n = parseFloat(value);
      return isNaN(n) ? 0 : n;
    }

    function formatYen(n) {
      return Math.round(n).toLocaleString("ja-JP");
    }

    function formatPercent(n) {
      return n.toFixed(1);
    }

    function getSelectedShippingMethod() {
      const id = document.getElementById("shippingMethod").value;
      return SHIPPING_METHODS.find((m) => m.id === id) || null;
    }

    /**********************************************
     * ⑤ 利益計算（販売価格→利益）
     **********************************************/
    function calculate() {
      const price = toNumber(document.getElementById("price").value);
      const cost = toNumber(document.getElementById("cost").value);
      const other = toNumber(document.getElementById("other").value);
      const shippingMethod = getSelectedShippingMethod();

      const marketResultsEl = document.getElementById("marketResults");

      if (price <= 0 || !shippingMethod) {
        marketResultsEl.innerHTML =
          '<div style="font-size:0.8rem;color:#9ca3af;">販売価格と発送方法を入力してください。</div>';
        updateShippingSummary();
        return;
      }

      let html = "";

      Object.values(MARKETPLACES).forEach((market) => {
        const feeAmount = price * (market.feeRate / 100);
        const shippingCost = shippingMethod.cost[market.key] ?? 0;
        const totalCost = cost + other + shippingCost;
        const profit = price - feeAmount - totalCost;
        const margin = (profit / price) * 100;

        const profitClass =
          profit < 0 ? "profit-value profit-negative" : "profit-value";

        html += `
          <div class="market-card">
            <div class="market-header">
              <div class="market-name">${market.label}</div>
              <div class="${profitClass}">
                利益：${formatYen(profit)} 円
              </div>
            </div>
            <div class="market-rows">
              <div class="row">
                <span class="label">販売価格</span>
                <span>${formatYen(price)} 円</span>
              </div>
              <div class="row">
                <span class="label">販売手数料（${formatPercent(market.feeRate)}%）</span>
                <span>${formatYen(feeAmount)} 円</span>
              </div>
              <div class="row">
                <span class="label">送料（${shippingMethod.label}）</span>
                <span>${formatYen(shippingCost)} 円</span>
              </div>
              <div class="row">
                <span class="label">原価＋その他経費</span>
                <span>${formatYen(cost + other)} 円</span>
              </div>
              <div class="row">
                <span class="label">利益率</span>
                <span>${formatPercent(margin)} %</span>
              </div>
            </div>
          </div>
        `;
      });

      marketResultsEl.innerHTML = html;
      updateShippingSummary();
    }

    /**********************************************
     * ⑥ 販売価格の逆算（目標利益→必要販売価格）
     *
     * 利益 = 価格 - 手数料 - (原価+その他+送料)
     * 手数料 = 価格 * r
     * => 利益 = 価格*(1-r) - 固定費
     * => 価格 = (利益 + 固定費) / (1-r)
     **********************************************/
    function calculatePriceFromProfit() {
      const targetProfit = toNumber(document.getElementById("targetProfit").value);
      const cost = toNumber(document.getElementById("cost").value);
      const other = toNumber(document.getElementById("other").value);
      const shippingMethod = getSelectedShippingMethod();

      const marketResultsEl = document.getElementById("marketResults");

      if (!shippingMethod) {
        marketResultsEl.innerHTML =
          '<div style="font-size:0.8rem;color:#9ca3af;">発送方法を選択してください。</div>';
        updateShippingSummary();
        return;
      }

      if (targetProfit === 0) {
        marketResultsEl.innerHTML =
          '<div style="font-size:0.8rem;color:#9ca3af;">目標利益（逆算用）を入力してください。（例: 500）</div>';
        updateShippingSummary();
        return;
      }

      let html = "";

      Object.values(MARKETPLACES).forEach((market) => {
        const r = market.feeRate / 100;
        const shippingCost = shippingMethod.cost[market.key] ?? 0;
        const fixedCost = cost + other + shippingCost;

        const denom = 1 - r;
        // あり得ないが、念のため
        if (denom <= 0) {
          html += `
            <div class="market-card">
              <div class="market-header">
                <div class="market-name">${market.label}</div>
                <div class="profit-value profit-negative">計算不可</div>
              </div>
              <div class="market-rows">
                <div class="row"><span class="label">理由</span><span>手数料率が高すぎます</span></div>
              </div>
            </div>
          `;
          return;
        }

        // 逆算販売価格（円）
        const requiredPrice = (targetProfit + fixedCost) / denom;

        // 表示用（切り上げ推奨：目標利益を割り込まないように）
        const displayPrice = Math.ceil(requiredPrice);

        // 参考：その価格のときの利益（丸め誤差確認用）
        const feeAmount = displayPrice * r;
        const profitCheck = displayPrice - feeAmount - fixedCost;

        const profitClass =
          profitCheck < 0 ? "profit-value profit-negative" : "profit-value";

        html += `
          <div class="market-card">
            <div class="market-header">
              <div class="market-name">${market.label}</div>
              <div class="profit-value">
                必要価格：${formatYen(displayPrice)} 円
              </div>
            </div>
            <div class="market-rows">
              <div class="row">
                <span class="label">目標利益</span>
                <span>${formatYen(targetProfit)} 円</span>
              </div>
              <div class="row">
                <span class="label">販売手数料（${formatPercent(market.feeRate)}%）</span>
                <span>約 ${formatYen(displayPrice * r)} 円</span>
              </div>
              <div class="row">
                <span class="label">送料（${shippingMethod.label}）</span>
                <span>${formatYen(shippingCost)} 円</span>
              </div>
              <div class="row">
                <span class="label">原価＋その他経費</span>
                <span>${formatYen(cost + other)} 円</span>
              </div>
              <div class="row">
                <span class="label">この価格の利益（参考）</span>
                <span class="${profitClass}">${formatYen(profitCheck)} 円</span>
              </div>
              <div class="row">
                <span class="label">ワンタップ反映</span>
                <span>
                  <button class="secondary" style="padding:6px 10px;border-radius:999px;"
                    onclick="setPriceAndCalc(${displayPrice})">この価格を販売価格へ</button>
                </span>
              </div>
            </div>
          </div>
        `;
      });

      marketResultsEl.innerHTML = html;
      updateShippingSummary();
    }

    // 逆算した価格を入力欄へ入れて、通常の利益計算を回す
    function setPriceAndCalc(price) {
      document.getElementById("price").value = price;
      calculate();
      // 逆算モードの結果が消えるので、必要なら targetProfit は残したまま
    }

    function updateShippingSummary() {
      const shippingMethod = getSelectedShippingMethod();
      const el = document.getElementById("shippingSummary");
      if (!shippingMethod) {
        el.textContent = "発送方法とサイト別送料をここに表示します。";
        return;
      }

      const lines = Object.values(MARKETPLACES).map((m) => {
        const cost = shippingMethod.cost[m.key];
        if (typeof cost !== "number") return `${m.label}: ー 円`;
        return `${m.label}: ${formatYen(cost)} 円`;
      });

      el.textContent = `「${shippingMethod.label}」の送料：` + lines.join(" / ");
    }

    /**********************************************
     * ⑦ 保存機能（現在の内容を保存）
     **********************************************/
    function handleSave() {
      const name = document.getElementById("itemName").value.trim();
      const price = toNumber(document.getElementById("price").value);
      const cost = toNumber(document.getElementById("cost").value);
      const other = toNumber(document.getElementById("other").value);
      const targetProfit = toNumber(document.getElementById("targetProfit").value);
      const shippingMethod = getSelectedShippingMethod();

      if (!name) {
        alert("商品名を入力してください。");
        return;
      }
      if (price <= 0) {
        alert("販売価格を入力してください。");
        return;
      }
      if (!shippingMethod) {
        alert("発送方法を選択してください。");
        return;
      }

      const items = loadSavedItems();
      const now = new Date().toISOString();

      const existingIndex = items.findIndex((item) => item.name === name);

      const data = {
        name,
        price,
        cost,
        other,
        targetProfit,          // ★保存対象に追加
        shippingMethodId: shippingMethod.id,
        updatedAt: now,
      };

      if (existingIndex >= 0) {
        items[existingIndex] = data;
      } else {
        items.push(data);
      }

      saveItemsToStorage(items);
      renderSavedItemsSelect();
      alert("保存しました。");
    }

    /**********************************************
     * ⑧ 保存済みデータの表示・読み込み・削除
     **********************************************/
    function renderSavedItemsSelect() {
      const select = document.getElementById("savedItemsSelect");
      const items = loadSavedItems();

      select.innerHTML = "";
      const emptyOpt = document.createElement("option");
      emptyOpt.value = "";
      emptyOpt.textContent = "（未選択）";
      select.appendChild(emptyOpt);

      items.forEach((item, index) => {
        const opt = document.createElement("option");
        opt.value = String(index);
        opt.textContent = item.name;
        select.appendChild(opt);
      });
    }

    function handleLoad() {
      const select = document.getElementById("savedItemsSelect");
      const index = parseInt(select.value, 10);
      const items = loadSavedItems();

      if (isNaN(index) || index < 0 || index >= items.length) {
        alert("読み込む商品を選択してください。");
        return;
      }

      const item = items[index];

      document.getElementById("itemName").value = item.name;
      document.getElementById("price").value = item.price;
      document.getElementById("cost").value = item.cost;
      document.getElementById("other").value = item.other;
      document.getElementById("targetProfit").value = item.targetProfit ?? ""; // ★読み込み追加

      const shippingSelect = document.getElementById("shippingMethod");
      shippingSelect.value = item.shippingMethodId;
      if (!shippingSelect.value) {
        shippingSelect.value = SHIPPING_METHODS[0]?.id || "";
      }

      updateShippingSummary();
      calculate();
    }

    function handleDelete() {
      const select = document.getElementById("savedItemsSelect");
      const index = parseInt(select.value, 10);
      const items = loadSavedItems();

      if (isNaN(index) || index < 0 || index >= items.length) {
        alert("削除する商品を選択してください。");
        return;
      }

      const name = items[index].name;
      if (!confirm(`「${name}」を削除しますか？`)) return;

      items.splice(index, 1);
      saveItemsToStorage(items);
      renderSavedItemsSelect();
      alert("削除しました。");
    }

    /**********************************************
     * ⑨ 初期化
     **********************************************/
    function init() {
      const shippingSelect = document.getElementById("shippingMethod");

      SHIPPING_METHODS.forEach((m) => {
        const opt = document.createElement("option");
        opt.value = m.id;
        opt.textContent = m.label;
        shippingSelect.appendChild(opt);
      });

      if (SHIPPING_METHODS.length > 0) {
        shippingSelect.value = SHIPPING_METHODS[0].id;
      }

      renderSavedItemsSelect();
      updateShippingSummary();
      calculate();
    }

    // イベント設定
    document.getElementById("calcBtn").addEventListener("click", calculate);
    document.getElementById("priceCalcBtn").addEventListener("click", calculatePriceFromProfit);
    document.getElementById("saveBtn").addEventListener("click", handleSave);
    document.getElementById("loadBtn").addEventListener("click", handleLoad);
    document.getElementById("deleteBtn").addEventListener("click", handleDelete);

    ["price", "cost", "other", "targetProfit", "itemName"].forEach((id) => {
      document.getElementById(id).addEventListener("input", () => {
        // 価格側を触っているなら利益計算を即更新
        if (id === "price" || id === "cost" || id === "other") {
          calculate();
        }
      });
    });

    document.getElementById("shippingMethod").addEventListener("change", () => {
      updateShippingSummary();
      calculate();
    });

    init();
  </script>
</body>
</html>
